/*
 * @description - Synesthesia Symphony
 * @copyright - 2014 Shipping Soon
 * @source - https://github.com/shippingsoon/Synesthesia-Symphony/
 * @website - https://www.shippingsoon.com/synesthesia-symphony/
 * @version - v0.06
 * @license - GPLv3
 */

'use strict';

/*
 * Retrieve data from a model by the primary ID.
 * @param {Object} restify - Restify module.
 * @param {Object} models - Sequelize models.
 * @param {Object} config - Server configuration.
 * @return {Function}
 */
exports.getModelById = function(restify, models, config) {
	/*
	 * @param {Object} request - Server request.
	 * @param {Object} response - Server response.
	 * @param {Function} next - Invokes the next handler.
	 * @return {Undefined}
	 */
	return function(request, response, next) {
		var model = request.params.model;
		var id = parseInt(request.params.id);
		var public_models = ['users', 'user_groups'];
		
		if (id && public_models.indexOf(model) !== -1) {
			models[model]
				.findById(id)
				.then(function(result) {
					response.setHeader('content-type', 'application/json');
					response.send([result.dataValues]);
					
					return next(false);
				}).catch(function(error) {  
					if (config.debug)
						console.log("error: %s", error);
					
					return next(new restify.InternalError());
				});
		}
		else
			return next(new restify.NotFoundError());
	}
};

/*
 * Retrieve data from a model. Accepts offset, limit and order.
 * @param {Object} restify - Restify module.
 * @param {Object} models - Sequelize models.
 * @param {Object} config - Server configuration.
 * @return {Function}
 */
exports.getModel = function(restify, models, config) {
	/*
	 * @param {Object} request - Server request.
	 * @param {Object} response - Server response.
	 * @param {Function} next - Invokes the next handler.
	 * @return {Undefined}
	 */
	return function(request, response, next) {
		var model = request.params.model;
		var offset = parseInt(request.params.offset) || 0;
		var limit = parseInt(request.params.limit) || 10;
		var order = parseInt(request.params.order);
		var public_models = ['users', 'user_groups'];
		
		if (public_models.indexOf(model) !== -1) {
			models[model]
				.findAll({offset: offset, limit: limit})
				.then(function(result) {
					response.setHeader('content-type', 'application/json');
					response.send(result);

					return next(false);
				}).catch(function(error) {
					if (config.debug)
						console.log("error: %s", error);
					
					return next(new restify.InternalError());
				});
		}
		else
			return next(new restify.NotFoundError());
	}
};

/*
 * Insert or update a record.
 * @param {Object} restify - Restify module.
 * @param {Object} models - Sequelize models.
 * @param {Object} config - Server configuration.
 * @return {Function}
 */
exports.upsertModel = function(restify, models, config) {
	/*
	 * @param {Object} request - Server request.
	 * @param {Object} response - Server response.
	 * @param {Function} next - Invokes the next handler.
	 * @return {Undefined}
	 */
	return function(request, response, next) {
		var model = request.params.model;
		var method = request.params.method;
		var public_models = ['users', 'groups'];
		var methods = ['upsert', 'create', 'update'];
		var is_valid = (request.body && public_models.indexOf(model) !== -1 && methods.indexOf(method) !== -1); 
		
		if (is_valid) {
			debugger;
			
			models[model][method](request.body)
				.then(function(result) {
					response.setHeader('content-type', 'application/json');
					response.send(200, result);
					
					return next(false);
				})
				.catch(function(error) {
					if (config.debug)
						console.log("error: %s", error);
					
					return next(new restify.InternalError());
				});
		}
		else
			return next(new restify.NotFoundError());
	}
};

